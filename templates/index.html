<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>NYC Housing Info</title>

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <!-- Header/Navbar (will use links to help navigate btw more upcoming features) -->
    <nav class="light-blue lighten-1" role="navigation">
      <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">Logo</a>
        <ul class="right hide-on-med-and-down">
          <li><a href="#">Navbar Link</a></li>
        </ul>
      </div>
    </nav>

    <!-- Hidden sidebar that will contain more info about affordable units -->
    <ul id="slide-out" class="sidenav">
        <li><a class="sidenav-close" href="#!">Clicking this will close Sidenav</a></li>
    </ul>

    <!-- Container for Map -->
    <div id="map"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Map functionalities in JavaScript -->
    <script>
    // Create sidebar object
    $(document).ready(function(){
      $('.sidenav').sidenav();
    });

    // Observing CSS changes in sidebar to adjust map accordingly. Needs to be done better. 
    var observer = new MutationObserver(function(mutations) {
    	mutations.forEach(function(mutation) {
    		if (mutation.target.firstChild.parentElement.style.transform === "translateX(-105%)") {
          $('#map').width("100%");
        }});
    });

    var observerConfig = {
    	attributes: true,
      attributeOldValue: true,
      attributeFilter: ['style'],
    	characterData: true
    };

    var targetNode = document.getElementById("slide-out");
    observer.observe(targetNode, observerConfig);

    var map;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 40.7609, lng: -73.9780},
        zoom: 12
      });

      //  coordinates of all neighborhoods
      var polygons = {{polygons | safe}}

      // all affordable units
      var units = {{ affordable_units | safe }};

      // Define the LatLng coordinates for one neighborhood's path.
      {% for ntaname, neighborhood_coords in polygons.items() %}
        var ntacode = "{{ neighborhoods[ntaname] | safe }}";
        var ntaname = "{{ ntaname | safe }}";
        var ntaunits = 0;

        var coords = {{neighborhood_coords | safe}};
        var all_coords = [];
        var bounds = new google.maps.LatLngBounds();

        // iterate through one polygon's coords and set each coord into LatLng object and add to bounds
        for (var i = 0; i < coords.length; i++) {
          all_coords[i] = {lat: coords[i][1], lng: coords[i][0]};
          bounds.extend(all_coords[i]);
        }

        // create neighborhood polygon
        var polygon_shape = new google.maps.Polygon({
          paths: all_coords,
          strokeColor: '#a8a8a8',
          strokeOpacity: 0,
          strokeWeight: 2,
          fillColor: '#a8a8a8',
          fillOpacity: 0,
          ntacode: ntacode,
          ntaname: ntaname,
          ntaunits: getAffordableUnitsInNta(ntacode, units),
          bounds: bounds
        });

        // creating basic colormap based on number of units in neighborhoods
        if (polygon_shape.ntaunits["Total Affordable Units"] == 0) {
          polygon_shape.fillOpacity = 0.4;
        } else {
          polygon_shape.strokeColor = '#f44542';
          polygon_shape.strokeOpacity = 0.5;
          polygon_shape.fillColor = '#f44542';
          polygon_shape.fillOpacity = 0.4;
        }

        var infoWindow;

        // add polygon to map and add listenier
        polygon_shape.setMap(map);
        polygon_shape.addListener('click', function(e) {
          showNta(e, infoWindow, this);
        });

        polygon_shape.addListener('click', function(e) {
          zoomIntoPolygon(e, this, map);
          adjustSideBar(e, this);
        })

        // initialize listener
        infoWindow = new google.maps.InfoWindow;
      {% endfor %}
    }

    // info window to show nta name, code, and num of affordable units
    function showNta(event, infoWindow, polygon) {
      var contentString = '<p><b>' + polygon.ntaname + ' | ' + polygon.ntacode + '</b><br>' +
                            'Low Income Units: ' + polygon.ntaunits['Low Income Units'] + '<br>' +
                            'Very Low Income Units: ' + polygon.ntaunits['Very Low Income Units'] + '<br>' +
                            'Extremely Low Income Units: ' + '</p>';

      // Replace the info window's content with nta name and nta code
      infoWindow.setContent(contentString);
      infoWindow.setPosition(event.latLng);

      infoWindow.open(map);
    }

    function zoomIntoPolygon(event, polygon, map) {
      map.fitBounds(polygon.bounds);
    }

    // open sidebar containing nta information and adjust map width
    function adjustSideBar(event, polygon) {
      $('.sidenav').sidenav('open');

      var sidenavTranslate = $('.sidenav').css('transform');

      if (sidenavTranslate === "matrix(1, 0, 0, 1, -315, 0)") {
        $('#map').width("100%");
      } else {
        var width = $('.sidenav').width();
        var parentWidth = $('.sidenav').offsetParent().width();
        var newMapWidth = 100 - 100*width/parentWidth;

        $('#map').width(newMapWidth.toString() + "%");
        $('#map').css("right", 0);
        $('#map').css("position", "fixed");
      }
    }

    function getAffordableUnitsInNta(ntacode, units) {
      /*
        Parameter: String, Array []
        NTA Code, array containing affordable units in all NTAs

        Return: Dict
        Dictionary containing number of low, very low, and extremely low income units of nta
      */

      var dict = new Object();
      dict["NTA Code"] = ntacode;
      dict["Low Income Units"] = 0;
      dict["Extremely Low Income Units"] = 0;
      dict["Very Low Income Units"] = 0;

      for (var i = 0; i < units.length; i++) {
        if (units[i].neighborhood_tabulation_area === ntacode && units[i].neighborhood_tabulation_area != null) {
          dict["Low Income Units"] += parseInt(units[i].low_income_units);
          dict["Very Income Units"] += parseInt(units[i].very_low_income_units);
          dict["Extremely Low Income Units"] += parseInt(units[i].extremely_low_income_units);

          i = units.length;
        }
      }

      dict["Total Affordable Units"] = dict["Low Income Units"] + dict["Extremely Low Income Units"] + dict["Very Low Income Units"];
      return dict;
    }
    </script>
    <script async defer
    src="//maps.googleapis.com/maps/api/js?key={{gmaps_token}}&callback=initMap"
    type="text/javascript" ></script>

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  </body>
</html>
